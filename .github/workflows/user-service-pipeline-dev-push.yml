
name: Stage, on PUSH Java CI/CD of user-service-ecommerce-boot, ecommerce-microservice-backend app

on:
  push:
    branches: [ develop ]

jobs:
  build_push:
    #needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'
    - name: Build with Maven
      run: mvn -B package --file pom.xml
    - name: Set up Docker variables
      id: docker
      run: |
        DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
        PROJECT_VERSION="${{ secrets.PROJECT_VERSION }}"
        if [ -z "$DOCKER_USERNAME" ]; then
          echo "Error: DOCKER_USERNAME secret is not set"
          exit 1
        fi
        if [ -z "$PROJECT_VERSION" ]; then
          PROJECT_VERSION="0.1.0"
          echo "Warning: PROJECT_VERSION not set, using default: $PROJECT_VERSION"
        fi
        IMAGE_TAG="${DOCKER_USERNAME}/user-service-ecommerce-boot:${PROJECT_VERSION}dev"
        echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "DOCKER_USERNAME=${DOCKER_USERNAME}" >> $GITHUB_OUTPUT
        echo "PROJECT_VERSION=${PROJECT_VERSION}" >> $GITHUB_OUTPUT
        echo "Building image: ${IMAGE_TAG}"
    - name: Docker Login
      run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
    - name: Build Docker image for user-service-ecommerce-boot Microservice
      run: docker build -f user-service/Dockerfile --build-arg PROJECT_VERSION=${{ steps.docker.outputs.PROJECT_VERSION }} -t ${{ steps.docker.outputs.IMAGE_TAG }} .
    - name: Push user-service-ecommerce-boot image
      run: docker push ${{ steps.docker.outputs.IMAGE_TAG }}


